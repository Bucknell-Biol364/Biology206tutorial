---
title: "Final 206"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the document where we will put all of the code we know we want to use for the BIOL 206 tutorial, as well as detailed descriptions of what the code is doing etc. 


Outline of project:

1. General introduction to Rstudio. Includes explanation of four panes, setting a working directory, code chunks, commands for queries, test commands? (Im thinking similar to the summary(cars) code that opens with each markdown file). The goal of this section is for students to understand the general layout and function of Rstudio so that they can complete the following two sections.

2. Guided Tutorial w/ basic tree. Students will be given a trait table and a pre-formatted tree code. Goals of this section are to help students navigate commands in R as well as to successfully construct, customize and interpret aspects of a tree. This tutorial is meant to give them the skills to complete the assignment given to them after this section. The tutorial includes how to set working directory to project folder, reading in a tree, summary data of tree command, general interpretation of tree, customization of tree. Customization includes labelling nodes with characteristics, highlighting specific branches, identifying mono/paraphyletic groups and visualizing them on the tree, identifying synapomorphies/symplesiomorphy. Could also include branched and unbranched trees and a few different ways to format the tree.

3. Plant Assignment. Now they will use the skills they learned from the guided tutorial to interpret and customize their own tree! An additional goal of this assignment is to help students understand their class material by working with data from their textbook and producing unique trees that highlight characteristics of their own choosing.


This first section is to get you acclimated to using R to look at trees and manipulate them. 

Test Tree

Reading in a table from a .csv (a type of excel file)
```{r character table for test tree}
data <- read.csv("trait_data.csv", header= TRUE, sep= ",")
```

Guided Tutorial begins now:

The following tutorial has been designed to walk you through the process of constructiong a phylogenic tree using R. You will learn about the different tools you will need to build a tree, how to customize a tree, and how to interpret information represented in a tree.

To begin, lets make sure that you have the tools you will need to make a tree!

R comes with many different types of tools that can be used to create and customize figures as well as analyze your data and create meaningful images. Often these tools are created by users and organized into different "packages" for other users to explore and use in their own work. The first thing you will need to do is to "load" the tools you will need into Rstudio. This is done by using the command "install.packages()" as well as the command "library()" to load the tool you will use.
 
Install the tidyverse package and load the ggtree tool by clicking the green arrow in the upper right corner of the grey code chunk.

```{r}
install.packages("tidyverse")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("ggtree", version = "3.8")
library(ggtree)
```
Note R amy ask you if you want to install all, some, or none of the package. Type a for all and hit enter. 

Now you will assign this newick file (a common text format for trees) the name text_string so you can use it to build a tree. The characters "<-" tells R that you want to assign information that you type to the right of it to the name that you type to the left of it. Now whenever you use the value "text_string", R will know that it includes the information in the newick file.

Assign the newick file to the name "text_string" now.

```{r tree text aka a newick file}
text_string <- "((((lamprey, sea bass),antelope), (bald eagle), alligator));"
```

Now look in the environment panel. Notice that you have populated it with a new variable called "text_string" and it contains the newick file. Great job!

Now you need to show R how to interpret the information contained in your new variable. To do this, you will use the command "read.tree()". This will make an "object" that now contains the information translated by R from the newick file into usable information for your tree! 

Use the command "read.tree()" to make an object called test_tree. This will be the object you use when plotting the tree. 

```{r reading tree}
test_tree <- read.tree(text=text_string)
```

Look back to the environment panel and click on the object "test_tree" to view the translated newick file.


Now that R is able to read the information you want to use, let's visualize this information into a tree! There are several functions for plotting phylogenic trees in R, but the simplest one is "plot()". This command works by typing the object that you want to plot followed by some formatting information."no.margin =" tells R to use the entire output frame to plot your tree and "edge.width =" tells R how thick to make the branches of your tree.

Plot your first tree now!

```{r plotting tree}
plot(test_tree,no.margin=TRUE, edge.width=1)
```
Viola! you have a tree! 

This looks great, but let's make some alterations so you can explore the options that R gives you in tree making. 

First lets get a general idea of the information represented in your tree by having R generate a summary for you.

```{r}
summary(test_tree)
```
Explore the informatin in the summary table. Notice that R can tell you how many tips and nodes are contained in your tree as well as what each tip label is. Also notice that you do not have nodes labelled on your tree. 

The "plot()" function is great for making simple trees, but if you want to get creative and customize your tree, it is much easier to use the function "ggtree()". This function allows you to highlight different parts of your tree, identify clades, find common ancestors as well as change the general aesthetics of your tree. First, lets use the same newick file that we translated above to make a basic ggtree. To add labels for our taxa we will use "+" and then a "geom_tiplab()" to label the tips.

Go ahead and make your tree using ggtree() and add labels to the tips of the tree usings "+ geom_tiplab()"
```{r}
ggtree(test_tree) + geom_tiplab()
```

Great! Notice that this tree is essentially the same tree you made using the "plot()" function, but now you will see how easy it is to customize your ggtree!

First, lets start by identifying a clade within your tree. Labelling a clade within a tree can be a really useful way to draw attention to a group of taxa that you want your reader to focus on. To highlight a clade we will use "geom_cladelabel()". Notice that there is some custom code within your clade label. "node =" tells R at what point in the tree to originate your clade. "label =" tells R what text you want to appear as your clade name and the following "color" "offset" and "align" are different aesthetic parameters for your clade label. 

```{r How to highlight a clade}
ggtree(test_tree) + 
  geom_tiplab()+
  geom_cladelabel(node=8, label="Clade 1", 
                  color="red", offset=.8, align=TRUE) 
```
You may be wondering how to know what node number your clade originates from. To do this you will want to map your nodes. Think of this as a map to your tree, you probably would not use this tree in a publication or paper, but you will use it to help generate more descriptive trees. 

```{r}
ggtree(test_tree) + 
   geom_text(aes(label=node), hjust=-.3)
```

Using your tree map, go back to the code chunk and label the clade that only includes nodes 1 and 2 (sea bass and lamprey) by telling R which node to originate your clade from.



But what if you are not sure what the most recent commonly shared ancestor is for a group of taxa? Ggtree has some helpful functions for this! The function "mrca()" will generate a table where you can find the most recently shared node between any two taxa. For example, the most recently shared node between lamprey and sea bass is at node 9. You can also use the function "getMRCA()" to find the most recent common ancestor of two or more taxa. To use this function, simply tell R what tree it should look at ("phy= test_tree") and what taxa you want to know about (to do this use tip = c("taxa 1", "taxa 2",...)). 
```{r}
mrca(phy = test_tree, full = FALSE)
getMRCA(phy= test_tree, tip= c("lamprey", "seabass"))
```
You can also assign an MRCA and its offspring by using the "<-" text to name your clade (remember the name you assign goes to the left) and the code you used with "findMRCA()" to assign this clade to the right. Try this now.


You may also want to change the branch colors of a clade to make them stand out on your tree more. To do this, we have to tell ggtree the members of a clade and then then tell it to color the brances connected to those members.
```{r THIS MAY WORK TO FOR CHANGING CLADE COLORS..NOT A CLOUD BUT ACHIEVES THE SAME THING}

#groupClade(test_tree, .node = c("seabass", "lamprey"), group_name = "group")

test_tree <- groupClade(test_tree, .node=9)
ggtree(test_tree, aes(color=group, linetype=group))


```


You can also identify monophyletic or paraphyletic groups by putting them in a "cloud" so that they stand out on your tree. 

```{r}
ggtree(test_tree) + 
  geom_tiplab() + 
  geom_hilight(node= 8, fill="gold") 
```



Here's the newick for the tree you will be using for the rest of this tutorial
Newicks are usually the output of tree building software like RAxML.

The tutorial will get you as far as building a basic tree, then you will need to use the code above to manipulate the tree!

```{r plant newick}
plants_newick <- "(Schmitzia_hiscockiana, (Nitellopsis_obtusa, ((Haplomitrium_cooperi, Blasia_pusilla, Porella_cordeana),((Sphagnum_cuspidata, Thuridium_delicatulum), ((Huperzia_lucidula, Lycopodium_digitatum), ((((Dryoteris marginalis, Dryopteris_intermedia),Dennstaedtia_punctilobula),((Equisetum_arvense)), ((Ginkgo_biloba, ((Pinus_strobilus, Pinus_rigida)), ((Baptisia_australis, Solanum_osscruentum,((Juglans_nigra, Carya_ovata)))))))))))));"
```
```{r reading plant newick}
plant_phylo <- read.tree(text=plants_newick)
```
```{r making basic plant phylo}
plot(plant_phylo,no.margin=TRUE, edge.width=1)
```

So now you have basic tree with a bunch of scientific names. The goal is for you to use your skills from above, knowledge of trees, and likely google to figure out what exactly is on the tree and manipulate it to answer some questions. 

1. Where are the most primitive plants? The most evolved? Find them and make the branch of the most primitive group red. 

2. Where did woody stems evolve? Find this branch and label it "Evolution of woody stems".

3. Find the fern(s). What is the most closely related species. Put a cloud around ferns and its close relative(s). 

4. Change the scientific name of one of the angiosperms to a common name.

5. Label the two monophyletic groups with the order they belong in.

6. Where did roots and/or tracheids evolve? Highlight that node.

7. Denote a paraphyletic group by changing the font color. Give a brief description of what that traits of that group are. (Water dwellers maybe?)

8. Note all the places where vascular elements evolved. 
